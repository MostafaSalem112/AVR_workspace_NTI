/*
 * TIMER0_program.c
 *
 *  Created on: Oct 27, 2023
 *      Author: Mostafa_Salem
 */
#include "../../LIB/Bit_Math.h"
#include "../../LIB/STD_Types.h"
#include "TIMER0_private.h"
#include "TIMER0_config.h"
#include "TIMER0_interface.h"

void (*TIMER0_NORMAL_GPfun)(void)=NULL;
void (*TIMER0_CTC_GPfun)(void)=NULL;

u32 TIMER,PreLoad,PreScaler;

void TIMER0_voidEnable(){

	TCCR0->CS0 = CLOCK_PRESCALER;
}

void TIMER0_voidDisable(){

	TCCR0->CS0 = Timer_Counter_stopped;
}

void TIMER0_INITIALZE(){

	TCCR0->FOC0 = Force_Output_Compare_STATUS;

	TCCR0->COM0 = Compare_Output_Mode;

	TCCR0->WGM00 = GET_BIT(TIMER_MODE,WGM00_BIT);
	TCCR0->WGM01 = GET_BIT(TIMER_MODE,WGM01_BIT);

	TIMSK->TOIE0 = Overflow_Interrupt_Status;
	TIMSK->OCIE0 = Compare_Match_Interrupt_Status;
}

void TIMER0_voidPreLoad(u8 Copy_u8Value){

	TCNT0 = Copy_u8Value;
}

void TIMER0_voidSetTimer(u32 Copy_u32TimeMS){

	u32 MAX_NUM = 256;
	u32 PREESCALER;


#if CLOCK_PRESCALER == No_prescaling
	PREESCALER = 1;
#elif CLOCK_PRESCALER == clkIO_8
	PREESCALER = 8;
#elif CLOCK_PRESCALER == clkIO_64
	PREESCALER = 64;
#elif CLOCK_PRESCALER == clkIO_256
	PREESCALER = 256;
#elif CLOCK_PRESCALER == 1024
	PREESCALER = 1024;
#endif

	u32 TIMER_freq=SYSTEM_CLOCK_FREQUENCY/PREESCALER;
	f32 Tick_Time=MICRO_IN_SEC/TIMER_freq;
	u32 OverFlow_Time=Tick_Time*MAX_NUM;

	TIMER=(Copy_u32TimeMS*MICRO_IN_MILLI)/OverFlow_Time;
	f32 remainder=((Copy_u32TimeMS*MICRO_IN_MILLI)%OverFlow_Time)/(f32)OverFlow_Time;
	PreLoad=(1-remainder)*MAX_NUM;

	TIMER0_voidPreLoad(PreLoad);
}

void TIMER0_NORMAL_SetCallBack(void(*ptr)(void)){

	TIMER0_NORMAL_GPfun=ptr;
}

void TIMER0_CTC_SetCallBack(void(*ptr)(void)){

	TIMER0_CTC_GPfun=ptr;
}

void __vector_10()__attribute__((signal));   // TIMER0_CTC
void __vector_10(){

	static u32 counter=0;

	if(counter==TIMER+1){
		if(TIMER0_CTC_GPfun!=NULL){
			TIMER0_CTC_GPfun();
		}
		counter=0;
		TIMER0_voidPreLoad(PreLoad);
	}
	else{
		counter++;
	}

}

void __vector_11()__attribute__((signal));   // TIMER0_NORMAL
void __vector_11(){

	static u32 counter=0;

	if(counter==TIMER+1){
		if(TIMER0_NORMAL_GPfun!=NULL){
			TIMER0_NORMAL_GPfun();
		}
		counter=0;
		TIMER0_voidPreLoad(PreLoad);
	}
	else{
		counter++;
	}

}
